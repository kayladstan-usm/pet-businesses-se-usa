<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        </style>
        <title>Pet Businesses of the Gulf Coast States</title>
    </head>
    <body>
        <div id="map">
        </div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="data/PetBusinessesintheSEUSA_1.js"></script>
        <script>
        var map = L.map('map', {
            zoomControl:false, maxZoom:20, minZoom:6
        }).fitBounds([[28.025404637812308,-101.51336441128038],[37.91296942303036,-84.367055973358]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        // modify popup if contains media
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.update();
                    }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    // Aggiorna il popup quando il video carica i metadati
                    video.addEventListener('loadedmetadata', function() {
                        popup.update();
                    });
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
        var title = new L.Control({'position':'topright'});
        title.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };
        title.update = function () {
            this._div.innerHTML = '<h2>Pet Businesses of the Gulf Coast States</h2>';
        };
        title.addTo(map);
        var abstract = new L.Control({'position':'bottomright'});
        abstract.onAdd = function (map) {
            this._div = L.DomUtil.create('div',
            'leaflet-control abstract');
            this._div.id = 'abstract'
                this._div.setAttribute("onmouseenter", "abstract.show()");
                this._div.setAttribute("onmouseleave", "abstract.hide()");
                this.hide();
                return this._div;
            };
            abstract.hide = function () {
                this._div.classList.remove("abstractUncollapsed");
                this._div.classList.add("abstract");
                this._div.innerHTML = 'i'
            }
            abstract.show = function () {
                this._div.classList.remove("abstract");
                this._div.classList.add("abstractUncollapsed");
                this._div.innerHTML = 'This web mapping application showcases the different pet related businesses in Louisiana, Mississippi, Alabama, and parts of Georgia and Arkansas. Each business is sized by the amount of sales revenue that it gets every year, however, you can find more information including the name and address of the business and number of employees if you click on any of the points. We hope this map helps you find your nearest local businesses where you can shop, care for, and pamper your furry friends.';
        };
        abstract.addTo(map);
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        L.control.locate({locateOptions: {maxZoom: 19}}).addTo(map);
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
        }
        map.createPane('pane_Basemap_0');
        map.getPane('pane_Basemap_0').style.zIndex = 400;
        var layer_Basemap_0 = L.tileLayer('http://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
            pane: 'pane_Basemap_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 6,
            maxZoom: 20,
        });
        layer_Basemap_0;
        map.addLayer(layer_Basemap_0);
        function pop_PetBusinessesintheSEUSA_1(feature, layer) {
            var popupContent = '<table>\
                    <tr>\
                        <td class="visible-with-data" id="CONAME" colspan="2"><strong>Business Name</strong><br />' + (feature.properties['CONAME'] !== null ? autolinker.link(String(feature.properties['CONAME']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td class="visible-with-data" id="STREET" colspan="2"><strong>Address</strong><br />' + (feature.properties['STREET'] !== null ? autolinker.link(String(feature.properties['STREET']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td class="visible-with-data" id="CITY" colspan="2"><strong>City</strong><br />' + (feature.properties['CITY'] !== null ? autolinker.link(String(feature.properties['CITY']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td class="visible-with-data" id="STATE_NAME" colspan="2"><strong>State</strong><br />' + (feature.properties['STATE_NAME'] !== null ? autolinker.link(String(feature.properties['STATE_NAME']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td class="visible-with-data" id="ZIP" colspan="2"><strong>ZIP</strong><br />' + (feature.properties['ZIP'] !== null ? autolinker.link(String(feature.properties['ZIP']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td class="visible-with-data" id="SALESVOL" colspan="2"><strong>Sales</strong><br />' + (feature.properties['SALESVOL'] !== null ? autolinker.link(String(feature.properties['SALESVOL']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td class="visible-with-data" id="EMPNUM" colspan="2"><strong>Number of Employees</strong><br />' + (feature.properties['EMPNUM'] !== null ? autolinker.link(String(feature.properties['EMPNUM']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_PetBusinessesintheSEUSA_1_0(feature) {
            if (feature.properties['SALESVOL'] >= 0.000000 && feature.properties['SALESVOL'] <= 25000.000000 ) {
                return {
                pane: 'pane_PetBusinessesintheSEUSA_1',
                radius: 2.0,
                opacity: 1,
                color: 'rgba(255,255,255,0.658)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(93,169,94,0.658)',
                interactive: true,
            }
            }
            if (feature.properties['SALESVOL'] >= 25000.000000 && feature.properties['SALESVOL'] <= 50000.000000 ) {
                return {
                pane: 'pane_PetBusinessesintheSEUSA_1',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(255,255,255,0.658)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(93,169,94,0.658)',
                interactive: true,
            }
            }
            if (feature.properties['SALESVOL'] >= 50000.000000 && feature.properties['SALESVOL'] <= 75000.000000 ) {
                return {
                pane: 'pane_PetBusinessesintheSEUSA_1',
                radius: 6.0,
                opacity: 1,
                color: 'rgba(255,255,255,0.658)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(93,169,94,0.658)',
                interactive: true,
            }
            }
            if (feature.properties['SALESVOL'] >= 75000.000000 && feature.properties['SALESVOL'] <= 100000.000000 ) {
                return {
                pane: 'pane_PetBusinessesintheSEUSA_1',
                radius: 8.0,
                opacity: 1,
                color: 'rgba(255,255,255,0.658)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(93,169,94,0.658)',
                interactive: true,
            }
            }
            if (feature.properties['SALESVOL'] >= 100000.000000 && feature.properties['SALESVOL'] <= 250000.000000 ) {
                return {
                pane: 'pane_PetBusinessesintheSEUSA_1',
                radius: 10.0,
                opacity: 1,
                color: 'rgba(255,255,255,0.658)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(93,169,94,0.658)',
                interactive: true,
            }
            }
            if (feature.properties['SALESVOL'] >= 250000.000000 && feature.properties['SALESVOL'] <= 500000.000000 ) {
                return {
                pane: 'pane_PetBusinessesintheSEUSA_1',
                radius: 12.0,
                opacity: 1,
                color: 'rgba(255,255,255,0.658)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(93,169,94,0.658)',
                interactive: true,
            }
            }
            if (feature.properties['SALESVOL'] >= 500000.000000 && feature.properties['SALESVOL'] <= 1000000.000000 ) {
                return {
                pane: 'pane_PetBusinessesintheSEUSA_1',
                radius: 14.0,
                opacity: 1,
                color: 'rgba(255,255,255,0.658)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(93,169,94,0.658)',
                interactive: true,
            }
            }
            if (feature.properties['SALESVOL'] >= 1000000.000000 && feature.properties['SALESVOL'] <= 25135000.000000 ) {
                return {
                pane: 'pane_PetBusinessesintheSEUSA_1',
                radius: 16.0,
                opacity: 1,
                color: 'rgba(255,255,255,0.658)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(93,169,94,0.658)',
                interactive: true,
            }
            }
        }
        map.createPane('pane_PetBusinessesintheSEUSA_1');
        map.getPane('pane_PetBusinessesintheSEUSA_1').style.zIndex = 401;
        map.getPane('pane_PetBusinessesintheSEUSA_1').style['mix-blend-mode'] = 'normal';
        var layer_PetBusinessesintheSEUSA_1 = new L.geoJson(json_PetBusinessesintheSEUSA_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_PetBusinessesintheSEUSA_1',
            layerName: 'layer_PetBusinessesintheSEUSA_1',
            pane: 'pane_PetBusinessesintheSEUSA_1',
            onEachFeature: pop_PetBusinessesintheSEUSA_1,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_PetBusinessesintheSEUSA_1_0(feature));
            },
        });
        bounds_group.addLayer(layer_PetBusinessesintheSEUSA_1);
        map.addLayer(layer_PetBusinessesintheSEUSA_1);
        const url = {"Nominatim OSM": "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&",
        "France BAN": "https://api-adresse.data.gouv.fr/search/?"}
        var photonControl = L.control.photon({
            url: url["Nominatim OSM"],
            feedbackLabel: '',
            position: 'topleft',
            includePosition: true,
            initial: true,
            // resultsHandler: myHandler,
        }).addTo(map);
        photonControl._container.childNodes[0].style.borderRadius="10px"
        // Create a variable to store the geoJSON data
        var x = null;
        // Create a variable to store the marker
        var marker = null;
        // Add an event listener to the Photon control to create a marker from the returned geoJSON data
        var z = null;
        photonControl.on('selected', function(e) {
            console.log(photonControl.search.resultsContainer);
            if (x != null) {
                map.removeLayer(obj3.marker);
                map.removeLayer(x);
            }
            obj2.gcd = e.choice;
            x = L.geoJSON(obj2.gcd).addTo(map);
            var label = typeof obj2.gcd.properties.label === 'undefined' ? obj2.gcd.properties.display_name : obj2.gcd.properties.label;
            obj3.marker = L.marker(x.getLayers()[0].getLatLng()).bindPopup(label).addTo(map);
            map.setView(x.getLayers()[0].getLatLng(), 17);
            z = typeof e.choice.properties.label === 'undefined'? e.choice.properties.display_name : e.choice.properties.label;
            console.log(e);
            e.target.input.value = z;
        });
        var search = document.getElementsByClassName("leaflet-photon leaflet-control")[0];
        search.classList.add("leaflet-control-search")
        search.style.display = "flex";
        search.style.backgroundColor="rgba(255,255,255,0.5)" 

        // Create the new button element
        var button = document.createElement("div");
        button.id = "gcd-button-control";
        button.className = "gcd-gl-btn fa fa-search search-button";

        // Insert the button at the beginning of the search control
        search.insertBefore(button, search.firstChild);
        last = search.lastChild;
        last.style.display = "none";
        button.addEventListener("click", function (e) {
            if (last.style.display === "none") {
                last.style.display = "block";
            } else {
                last.style.display = "none";
            }
        });
        setBounds();
        map.addControl(new L.Control.Search({
            layer: layer_PetBusinessesintheSEUSA_1,
            initial: false,
            hideMarkerOnCollapse: true,
            propertyName: 'CONAME'}));
        if (typeof url === 'undefined') {
            document.getElementsByClassName('search-button')[0].className += ' fa fa-binoculars';
        } else {
            document.getElementsByClassName('search-button')[1].className += ' fa fa-binoculars';
        }
        resetLabels([layer_PetBusinessesintheSEUSA_1]);
        map.on("zoomend", function(){
            resetLabels([layer_PetBusinessesintheSEUSA_1]);
        });
        map.on("layeradd", function(){
            resetLabels([layer_PetBusinessesintheSEUSA_1]);
        });
        map.on("layerremove", function(){
            resetLabels([layer_PetBusinessesintheSEUSA_1]);
        });
        </script>        
    </body>
</html>
